<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•ç•Œé¢</title>    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
        }

        #loginContainer {
            display: block;
            text-align: center;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        input {
            padding: 8px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-right: 10px;
        }
        
        button {
            padding: 8px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #45a049;
        }

        #mainContainer {
            display: none;
            text-align: center;
        }        #username-display {
            margin: 20px 0 40px;
            font-size: 24px;
            color: #333;
        }

        .upload-container {
            border: 2px dashed #4CAF50;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f8f8f8;
        }

        .upload-container:hover, .upload-container.dragover {
            background-color: #e8f5e9;
            border-color: #2e7d32;
        }

        .upload-container p {
            margin: 0;
            font-size: 16px;
            color: #666;
        }

        .upload-icon {
            font-size: 48px;
            color: #4CAF50;
            margin-bottom: 15px;
        }

        #fileList {
            margin-top: 20px;
            text-align: left;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }        .file-item {
            display: flex;
            align-items: center;
            padding: 8px;
            background-color: white;
            border-radius: 4px;
            margin-bottom: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-item:hover {
            background-color: #f5f5f5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        }

        .file-item input[type="checkbox"] {
            margin-right: 10px;
        }

        .file-name {
            flex-grow: 1;
            margin-right: 10px;
        }

        .file-size {
            color: #666;
            font-size: 14px;
        }

        .manage-mode .file-item {
            cursor: default;
        }

        .manage-buttons {
            display: none;
            margin-top: 10px;
        }

        .manage-buttons.active {
            display: block;
        }

        .manage-btn {
            padding: 8px 16px;
            margin-right: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .manage-btn:hover {
            background-color: #45a049;
        }

        .delete-btn {
            background-color: #ff4444;
        }

        .delete-btn:hover {
            background-color: #cc0000;
        }

        .file-preview {
            width: 100%;
            max-height: 80vh;
            margin-top: 20px;
            display: none;
        }

        .file-preview.active {
            display: block;
        }.settings-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .settings-btn:hover {
            background-color: #45a049;
        }        .settings-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 300px;
            height: 100vh;
            background-color: white;
            padding: 20px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: none;
            z-index: 999;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .settings-panel.active {
            display: block;
            transform: translateX(0);
        }        .settings-panel h3 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 20px;
            color: #333;
        }

        .settings-content {
            margin-top: 20px;
        }

        .settings-btn-group {
            margin-top: 15px;
        }

        .delete-btn {
            background-color: #ff4444;
            margin-top: 10px;
        }

        .delete-btn:hover {
            background-color: #cc0000;
        }

        .settings-input {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }

        .settings-input.active {
            display: block;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            display: none;
            z-index: 998;
        }

        .overlay.active {
            display: block;
        }        .github-auth {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1002;
        }
        
        .github-auth.active {
            display: flex;
        }
        
        .github-auth-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 90%;
        }
        
        .github-auth-content h3 {
            margin-top: 0;
            margin-bottom: 20px;
        }
        
        .upload-actions {
            margin-top: 20px;
            text-align: center;
        }
        
        .upload-btn {
            background-color: #2196F3;
            margin: 10px;
        }
        
        .upload-btn:hover {
            background-color: #1976D2;
        }

        .github-file-list {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #f9f9f9;
            display: none;
        }

        .github-file-list.active {
            display: block;
        }

        .github-file-item {
            padding: 8px;
            margin-bottom: 5px;
            background-color: white;
            border: 1px solid #eee;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .github-file-item:hover {
            background-color: #f5f5f5;
        }

        .github-file-name {
            flex-grow: 1;
            margin-right: 10px;
        }

        #uploadContainer {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #uploadContainer.dragover {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }

        #uploadContainer:hover {
            border-color: #999;
        }

        .upload-text {
            color: #666;
            margin: 10px 0;
        }

        #fileInput {
            display: none;
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 4px;
            z-index: 1001;
            display: none;
        }

        .message.success {
            background-color: #4CAF50;
            color: white;
        }

        .message.error {
            background-color: #ff4444;
            color: white;
        }
    </style>
</head>
<body>    <div id="loginContainer">
        <div class="input-group">
            <input type="text" id="usernameInput" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            <button onclick="login()">ç¡®è®¤</button>
        </div>    </div>    <div id="mainContainer">
        <div id="username-display"></div>        <div class="upload-container" id="uploadContainer" onclick="triggerFileSelect()">
            <div class="upload-icon">ğŸ“</div>
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ä¸Šä¼ </p>
            <input type="file" id="fileInput" style="display: none;" multiple>
        </div>        <div class="upload-actions">
            <button class="upload-btn" onclick="uploadToGithub()">ä¸Šä¼ </button>
        </div>
        <div id="fileList"></div>
        <div class="manage-buttons" id="manageButtons">
            <button onclick="deleteSelectedFiles()" class="delete-btn">ç¡®è®¤åˆ é™¤</button>
            <button class="manage-btn cancel" onclick="toggleManageMode()">å–æ¶ˆ</button>
        </div>
    </div>    <!-- è®¾ç½®æŒ‰é’®å’Œé¢æ¿ -->
    <button class="settings-btn" id="settingsBtn">è®¾ç½®</button>
    <div class="overlay" id="overlay"></div>    <div class="settings-panel" id="settingsPanel">
        <h3>è®¾ç½®</h3>
        <div class="settings-content">            
            <div class="settings-btn-group">
                <button onclick="showChangeUsername()">ä¿®æ”¹ç”¨æˆ·å</button>
            </div>
            <input type="text" id="newUsernameInput" class="settings-input" placeholder="è¾“å…¥æ–°çš„ç”¨æˆ·å">            <div class="settings-btn-group" id="confirmBtnGroup" style="display: none;">
                <button onclick="confirmChangeUsername()">ç¡®å®š</button>
                <button onclick="cancelChangeUsername()">å–æ¶ˆ</button>
            </div>
            <div class="settings-btn-group">
                <button onclick="showAllFiles()">æ‰€æœ‰æ–‡ä»¶</button>
            </div>
            <div class="settings-btn-group">
                <button onclick="showUserFiles()">å·²æ·»åŠ çš„æ–‡ä»¶</button>
            </div>
            <div id="githubFileList" class="github-file-list"></div>
            <div id="userFileList" class="github-file-list"></div>
        </div>
    </div><!-- Githubè®¤è¯å¯¹è¯æ¡† -->
    <div class="github-auth" id="githubAuthDialog">
        <div class="github-auth-content">
            <h3>GitHub è®¤è¯</h3>
            <p>é¦–æ¬¡ä¸Šä¼ éœ€è¦è¾“å…¥ GitHub Token</p>
            <input type="password" id="githubToken" placeholder="è¾“å…¥ GitHub Token">
            <div class="settings-btn-group">
                <button onclick="confirmGithubAuth()">ç¡®è®¤</button>
                <button onclick="cancelGithubAuth()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>    <script>        // å…¨å±€çŠ¶æ€ç®¡ç†
        const state = {
            github: {
                api: 'https://api.github.com',
                owner: 'superclam',
                repo: 'KU',
                folder: 'ä»“åº“',
                token: ''  // åˆå§‹ä¸ºç©ºï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥æˆ–ä»localStorageè·å–
            },
            files: {
                local: [],     // æœ¬åœ°å¾…ä¸Šä¼ çš„æ–‡ä»¶
                remote: [],    // GitHubä»“åº“ä¸­çš„æ‰€æœ‰æ–‡ä»¶
                userFiles: [], // å½“å‰ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶
                isManageMode: false
            }
        };

        // æ£€æŸ¥localStorageä¸­æ˜¯å¦æœ‰ä¿å­˜çš„token
        const savedToken = localStorage.getItem('github_token');
        if (savedToken) {
            state.github.token = savedToken;
        }        // æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ä¿å­˜çš„ç”¨æˆ·å
        window.onload = async function() {
            const savedUsername = localStorage.getItem('username');
            if (savedUsername) {
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('username-display').textContent = 'æ¬¢è¿ï¼Œ' + savedUsername;
                
                // åˆå§‹åŒ–æ—¶è·å–è¿œç¨‹æ–‡ä»¶åˆ—è¡¨
                const savedToken = localStorage.getItem('github_token');
                if (savedToken) {
                    state.github.token = savedToken;
                    await updateFileListsAfterUpload(); // è·å–è¿œç¨‹æ–‡ä»¶åˆ—è¡¨
                }
            }
        };

        function login() {
            const username = document.getElementById('usernameInput').value;
            if (username.trim() !== "") {
                localStorage.setItem('username', username);
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                document.getElementById('username-display').textContent = 'æ¬¢è¿ï¼Œ' + username;
            } else {
                alert('è¯·è¾“å…¥ç”¨æˆ·å');
            }
        }

        // æ”¯æŒæŒ‰å›è½¦é”®ç¡®è®¤
        document.getElementById('usernameInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });

        // è®¾ç½®æŒ‰é’®ç›¸å…³åŠŸèƒ½
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsPanel = document.getElementById('settingsPanel');
        const overlay = document.getElementById('overlay');

        function toggleSettings() {
            settingsPanel.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        settingsBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleSettings();
        });

        document.addEventListener('click', function(e) {
            if (settingsPanel.classList.contains('active') &&
                !settingsPanel.contains(e.target) &&
                e.target !== settingsBtn) {
                toggleSettings();
            }
        });        // é˜»æ­¢è®¾ç½®é¢æ¿çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
        settingsPanel.addEventListener('click', function(e) {
            e.stopPropagation();
        });        // ä¿®æ”¹ç”¨æˆ·åç›¸å…³åŠŸèƒ½
        function showChangeUsername() {
            document.getElementById('newUsernameInput').value = '';
            document.getElementById('newUsernameInput').classList.add('active');
            document.getElementById('confirmBtnGroup').style.display = 'block';
            
            // ç»™æ–°ç”¨æˆ·åè¾“å…¥æ¡†æ·»åŠ å›è½¦äº‹ä»¶ç›‘å¬
            document.getElementById('newUsernameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmChangeUsername();
                }
            });
        }

        function confirmChangeUsername() {
            const oldUsername = localStorage.getItem('username');
            const newUsername = document.getElementById('newUsernameInput').value;
            if (newUsername.trim() !== "") {
                // æ›´æ–°ç”¨æˆ·æ–‡ä»¶å…³è”
                const oldUserPrefix = `${oldUsername}_`;
                const newUserPrefix = `${newUsername}_`;
                
                // æ›´æ–°è¿œç¨‹æ–‡ä»¶åˆ—è¡¨ä¸­çš„æ–‡ä»¶å
                if (state.files.remote) {
                    state.files.remote = state.files.remote.map(file => {
                        if (file.name.startsWith(oldUserPrefix)) {
                            return {
                                ...file,
                                name: newUserPrefix + file.name.substring(oldUserPrefix.length)
                            };
                        }
                        return file;
                    });
                }
                
                // æ›´æ–°ç”¨æˆ·æ–‡ä»¶åˆ—è¡¨
                if (state.files.userFiles) {
                    state.files.userFiles = state.files.userFiles.map(file => {
                        if (file.name.startsWith(oldUserPrefix)) {
                            return {
                                ...file,
                                name: newUserPrefix + file.name.substring(oldUserPrefix.length)
                            };
                        }
                        return file;
                    });
                }

                // æ›´æ–°ç”¨æˆ·åå’ŒUI
                localStorage.setItem('username', newUsername);
                document.getElementById('username-display').textContent = 'æ¬¢è¿ï¼Œ' + newUsername;
                
                // æ›´æ–°æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤º
                updateGithubFileList();
                updateUserFileList();
                
                cancelChangeUsername();
                toggleSettings();
            } else {
                alert('è¯·è¾“å…¥æ–°çš„ç”¨æˆ·å');
            }
        }        function cancelChangeUsername() {
            document.getElementById('newUsernameInput').classList.remove('active');
            document.getElementById('confirmBtnGroup').style.display = 'none';
        }        // æ–‡ä»¶ç®¡ç†ç›¸å…³åŠŸèƒ½
        let isManageMode = false; // ç§»åˆ°è¿™é‡Œï¼Œç¡®ä¿åœ¨ä½¿ç”¨å‰å®šä¹‰

        function showFileManager() {
            isManageMode = !isManageMode;
            const manageButtons = document.getElementById('manageButtons');
            const fileListContainer = document.getElementById('fileList');
            const checkboxes = document.querySelectorAll('.file-item input[type="checkbox"]');
            
            if (isManageMode) {
                fileListContainer.classList.add('manage-mode');
                manageButtons.classList.add('active');
                checkboxes.forEach(cb => cb.style.display = 'block');
            } else {
                fileListContainer.classList.remove('manage-mode');
                manageButtons.classList.remove('active');
                checkboxes.forEach(cb => {
                    cb.style.display = 'none';
                    cb.checked = false;
                });
            }
        }function deleteSelectedFiles() {
            const checkboxes = document.querySelectorAll('.file-item input[type="checkbox"]:checked');
            const indicesToDelete = Array.from(checkboxes)
                .map(checkbox => parseInt(checkbox.closest('.file-item').getAttribute('data-index')))
                .sort((a, b) => b - a); // ä»å¤§åˆ°å°æ’åºï¼Œè¿™æ ·åˆ é™¤æ—¶ä¸ä¼šå½±å“å…¶ä»–ç´¢å¼•

            if (indicesToDelete.length === 0) {
                alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„æ–‡ä»¶');
                return;
            }

            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${indicesToDelete.length} ä¸ªæ–‡ä»¶å—ï¼Ÿ`)) {
                // ä»æ•°ç»„ä¸­åˆ é™¤æ–‡ä»¶
                indicesToDelete.forEach(index => {
                    state.files.local.splice(index, 1);
                });

                // æ›´æ–°ä¸»ç•Œé¢çš„æ–‡ä»¶åˆ—è¡¨
                updateMainFileList();
                // é€€å‡ºç®¡ç†æ¨¡å¼
                toggleManageMode();
            }
        }

        function updateMainFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            state.files.local.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.setAttribute('data-index', index);
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.style.display = state.files.isManageMode ? 'block' : 'none';
                
                const fileName = document.createElement('div');
                fileName.className = 'file-name';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('div');
                fileSize.className = 'file-size';
                fileSize.textContent = formatFileSize(file.size);
                
                fileItem.appendChild(checkbox);
                fileItem.appendChild(fileName);
                fileItem.appendChild(fileSize);
                
                // åˆ†åˆ«ä¸º checkbox å’Œæ–‡ä»¶é¡¹æ·»åŠ äº‹ä»¶ç›‘å¬
                checkbox.addEventListener('click', (e) => {
                    e.stopPropagation(); // é˜²æ­¢è§¦å‘æ–‡ä»¶é¡¹çš„ç‚¹å‡»äº‹ä»¶
                });
                
                fileItem.addEventListener('click', (e) => {
                    if (state.files.isManageMode) {
                        if (e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked; // ç‚¹å‡»æ–‡ä»¶é¡¹æ—¶åˆ‡æ¢å¤é€‰æ¡†çŠ¶æ€
                        }
                    } else {
                        if (e.target !== checkbox) {
                            openFile(index);
                        }
                    }
                });
                
                fileList.appendChild(fileItem);
            });

            // å¦‚æœæ˜¯ç®¡ç†æ¨¡å¼ï¼Œç¡®ä¿æŒ‰é’®å¯è§
            const manageButtons = document.getElementById('manageButtons');
            if (state.files.isManageMode) {
                manageButtons.classList.add('active');
            }
        }

        function openFile(index) {
            const file = state.files.local[index];
            if (file) {
                const url = URL.createObjectURL(file);
                window.open(url, '_blank');
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            }
        }

        // æ–‡ä»¶ä¸Šä¼ å’Œå¤„ç†ç›¸å…³åŠŸèƒ½
        const uploadContainer = document.getElementById('uploadContainer');
        const fileInput = document.getElementById('fileInput');

        function triggerFileSelect() {
            document.getElementById('fileInput').click();
        }

        // æ‹–æ‹½ç›¸å…³çš„äº‹ä»¶å¤„ç†
        uploadContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadContainer.classList.add('dragover');
        });

        uploadContainer.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadContainer.classList.remove('dragover');
        });

        uploadContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadContainer.classList.remove('dragover');
            handleFiles({ target: { files: e.dataTransfer.files } });
        });

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        fileInput.addEventListener('change', handleFiles);

        async function handleFiles(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            state.files.local = [...state.files.local, ...Array.from(files)];
            updateMainFileList();
        }

        function updateMainFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            state.files.local.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.setAttribute('data-index', index);
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.style.display = state.files.isManageMode ? 'block' : 'none';
                
                const fileName = document.createElement('div');
                fileName.className = 'file-name';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('div');
                fileSize.className = 'file-size';
                fileSize.textContent = formatFileSize(file.size);
                
                fileItem.appendChild(checkbox);
                fileItem.appendChild(fileName);
                fileItem.appendChild(fileSize);
                
                checkbox.addEventListener('click', (e) => e.stopPropagation());
                
                fileItem.addEventListener('click', (e) => {
                    if (state.files.isManageMode) {
                        if (e.target !== checkbox) {
                            checkbox.checked = !checkbox.checked;
                        }
                    } else {
                        if (e.target !== checkbox) {
                            openFile(index);
                        }
                    }
                });
                
                fileList.appendChild(fileItem);
            });
            
            const manageButtons = document.getElementById('manageButtons');
            if (state.files.isManageMode) {
                manageButtons.classList.add('active');
            }
        }

        function openFile(index) {
            const file = state.files.local[index];
            if (file) {
                const url = URL.createObjectURL(file);
                window.open(url, '_blank');
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            }
        }

        function showMessage(message, type = 'info') {
            const messageDiv = document.getElementById('message') || createMessageDiv();
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        function createMessageDiv() {
            const div = document.createElement('div');
            div.id = 'message';
            document.body.appendChild(div);
            return div;
        }

        // ç§»é™¤æ—§çš„ filesArray å˜é‡
        function handleFiles(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;
            
            const startIndex = state.files.local.length;
            state.files.local = [...state.files.local, ...Array.from(files)];
            
            // æ›´æ–°æ˜¾ç¤ºçš„æ–‡ä»¶åˆ—è¡¨
            updateMainFileList();
        }        function openFileInNewTab(url) {
            const win = window.open();
            if (win) {
                win.document.write('<iframe src="' + url + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');
            } else {
                alert('è¯·å…è®¸æ‰“å¼€å¼¹çª—ä»¥æŸ¥çœ‹æ–‡ä»¶');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function toggleManageMode() {
            isManageMode = !isManageMode;
            const manageButtons = document.getElementById('manageButtons');
            const fileListContainer = document.getElementById('fileList');
            const checkboxes = document.querySelectorAll('.file-item input[type="checkbox"]');
            
            if (isManageMode) {
                fileListContainer.classList.add('manage-mode');
                manageButtons.classList.add('active');
                checkboxes.forEach(cb => cb.style.display = 'block');
            } else {
                fileListContainer.classList.remove('manage-mode');
                manageButtons.classList.remove('active');
                checkboxes.forEach(cb => {
                    cb.style.display = 'none';
                    cb.checked = false;
                });
            }
        }        // ä½¿ç”¨stateä¸­çš„GitHubé…ç½®

        async function uploadToGithub() {
            if (!state.files.local.length) {
                alert('è¯·å…ˆé€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
                return;
            }

            if (!state.github.token) {
                document.getElementById('githubAuthDialog').classList.add('active');
                return;
            }

            try {
                const username = localStorage.getItem('username');
                if (!username) {
                    throw new Error('æœªæ‰¾åˆ°ç”¨æˆ·å');
                }

                for (const file of state.files.local) {
                    const content = await readFileAsBase64(file);
                    const fileNameWithPrefix = `${username}_${file.name}`;
                    
                    const checkResponse = await fetch(`${state.github.api}/repos/${state.github.owner}/${state.github.repo}/contents/${state.github.folder}/${fileNameWithPrefix}`, {
                        headers: {
                            'Authorization': `token ${state.github.token}`
                        }
                    });

                    let requestBody = {
                        message: `ä¸Šä¼ æ–‡ä»¶: ${fileNameWithPrefix}`,
                        content: content
                    };

                    if (checkResponse.ok) {
                        const fileInfo = await checkResponse.json();
                        requestBody.sha = fileInfo.sha;
                    }

                    const response = await fetch(`${state.github.api}/repos/${state.github.owner}/${state.github.repo}/contents/${state.github.folder}/${fileNameWithPrefix}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${state.github.token}`,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`ä¸Šä¼ å¤±è´¥: ${errorData.message || response.statusText}`);
                    }                    const fileInfo = await response.json();
                    // æ›´æ–°æ–‡ä»¶åˆ—è¡¨
                    updateRemoteFileList(fileInfo.content);
                }

                // æ›´æ–°æ‰€æœ‰æ–‡ä»¶å’Œç”¨æˆ·æ–‡ä»¶çš„æ˜¾ç¤º
                await updateFileListsAfterUpload();
                
                // æ¸…ç©ºæœ¬åœ°æ–‡ä»¶åˆ—è¡¨
                state.files.local = [];
                updateMainFileList();
                
                showMessage('æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('ä¸Šä¼ é”™è¯¯:', error);
                showMessage(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }        function updateRemoteFileList(fileInfo) {
            // æ›´æ–°è¿œç¨‹æ–‡ä»¶åˆ—è¡¨
            const existingIndex = state.files.remote.findIndex(f => f.name === fileInfo.name);
            if (existingIndex >= 0) {
                state.files.remote[existingIndex] = fileInfo;
            } else {
                state.files.remote.push(fileInfo);
            }

            // å¦‚æœæ˜¯å½“å‰ç”¨æˆ·çš„æ–‡ä»¶ï¼Œä¹Ÿæ›´æ–°ç”¨æˆ·æ–‡ä»¶åˆ—è¡¨
            const username = localStorage.getItem('username');
            if (fileInfo.name.startsWith(`${username}_`)) {
                const existingUserFileIndex = state.files.userFiles.findIndex(f => f.name === fileInfo.name);
                if (existingUserFileIndex >= 0) {
                    state.files.userFiles[existingUserFileIndex] = fileInfo;
                } else {
                    state.files.userFiles.push(fileInfo);
                }
            }
        }

        async function updateFileListsAfterUpload() {
            // åˆ·æ–°è¿œç¨‹æ–‡ä»¶åˆ—è¡¨
            const response = await fetch(`${state.github.api}/repos/${state.github.owner}/${state.github.repo}/contents/${state.github.folder}`, {
                headers: {
                    'Authorization': `token ${state.github.token}`
                }
            });

            if (response.ok) {
                const files = await response.json();
                state.files.remote = files;

                // æ›´æ–°ç”¨æˆ·æ–‡ä»¶åˆ—è¡¨
                const username = localStorage.getItem('username');
                state.files.userFiles = files.filter(file => file.name.startsWith(`${username}_`));

                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                updateGithubFileList();
                updateUserFileList();
            }
        }

        function updateFileListDisplay() {
            if (document.getElementById('githubFileList').classList.contains('active')) {
                updateGithubFileList();
            }
            if (document.getElementById('userFileList').classList.contains('active')) {
                updateUserFileList();
            }
        }

        // GitHub è®¤è¯ç›¸å…³åŠŸèƒ½
        function confirmGithubAuth() {
            const token = document.getElementById('githubToken').value.trim();
            if (!token) {
                showMessage('è¯·è¾“å…¥ GitHub Token', 'error');
                return;
            }

            state.github.token = token;
            localStorage.setItem('github_token', token);
            document.getElementById('githubAuthDialog').classList.remove('active');
            uploadToGithub();
        }

        function cancelGithubAuth() {
            document.getElementById('githubAuthDialog').classList.remove('active');
        }        // æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤ºç›¸å…³åŠŸèƒ½
        async function showAllFiles() {
            const fileList = document.getElementById('githubFileList');
            const userFileList = document.getElementById('userFileList');
            
            // åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
            if (fileList.classList.contains('active')) {
                fileList.classList.remove('active');
            } else {
                fileList.classList.add('active');
                userFileList.classList.remove('active');
                
                if (!state.files.remote.length && state.github.token) {
                    // å¦‚æœæ²¡æœ‰æ–‡ä»¶åˆ—è¡¨ä¸”æœ‰tokenï¼Œå°è¯•è·å–
                    try {
                        await updateFileListsAfterUpload();
                    } catch (error) {
                        console.error('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                        showMessage('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼š' + error.message, 'error');
                    }
                }
                // æ— è®ºæ˜¯å¦æˆåŠŸè·å–åˆ°æ–°æ•°æ®ï¼Œéƒ½æ›´æ–°æ˜¾ç¤º
                updateGithubFileList();
            }
        }        async function showUserFiles() {
            const fileList = document.getElementById('githubFileList');
            const userFileList = document.getElementById('userFileList');
            
            // åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
            if (userFileList.classList.contains('active')) {
                userFileList.classList.remove('active');
            } else {
                userFileList.classList.add('active');
                fileList.classList.remove('active');
                
                if (!state.files.userFiles.length && state.github.token) {
                    // å¦‚æœæ²¡æœ‰æ–‡ä»¶åˆ—è¡¨ä¸”æœ‰tokenï¼Œå°è¯•è·å–
                    try {
                        await updateFileListsAfterUpload();
                    } catch (error) {
                        console.error('è·å–ç”¨æˆ·æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                        showMessage('è·å–ç”¨æˆ·æ–‡ä»¶åˆ—è¡¨å¤±è´¥ï¼š' + error.message, 'error');
                    }
                }
                // æ— è®ºæ˜¯å¦æˆåŠŸè·å–åˆ°æ–°æ•°æ®ï¼Œéƒ½æ›´æ–°æ˜¾ç¤º
                updateUserFileList();
            }
        }

        function updateGithubFileList() {
            const fileList = document.getElementById('githubFileList');
            fileList.innerHTML = '';

            if (!state.files.remote || state.files.remote.length === 0) {
                fileList.innerHTML = '<div class="github-file-item">æš‚æ— æ–‡ä»¶</div>';
                return;
            }

            state.files.remote.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'github-file-item';
                
                const fileName = document.createElement('div');
                fileName.className = 'github-file-name';
                // å»æ‰ç”¨æˆ·åå‰ç¼€åæ˜¾ç¤ºæ–‡ä»¶å
                const displayName = file.name.includes('_') ? file.name.split('_').slice(1).join('_') : file.name;
                fileName.textContent = displayName;
                
                fileItem.appendChild(fileName);
                fileList.appendChild(fileItem);
                
                // æ·»åŠ ç‚¹å‡»æŸ¥çœ‹åŠŸèƒ½
                fileItem.addEventListener('click', () => {
                    window.open(file.download_url, '_blank');
                });
            });
        }

        function updateUserFileList() {
            const userFileList = document.getElementById('userFileList');
            userFileList.innerHTML = '';

            if (!state.files.userFiles || state.files.userFiles.length === 0) {
                userFileList.innerHTML = '<div class="github-file-item">æš‚æ— æ–‡ä»¶</div>';
                return;
            }

            state.files.userFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'github-file-item';
                
                const displayName = file.name.split('_').slice(1).join('_');
                
                const fileName = document.createElement('div');
                fileName.className = 'github-file-name';
                fileName.textContent = displayName;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.textContent = 'åˆ é™¤';
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    if (confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ ${displayName} å—ï¼Ÿ`)) {
                        await deleteFileFromGithub(file.name);
                    }
                };
                
                fileItem.appendChild(fileName);
                fileItem.appendChild(deleteBtn);
                userFileList.appendChild(fileItem);
                
                // æ·»åŠ ç‚¹å‡»æŸ¥çœ‹åŠŸèƒ½
                fileName.addEventListener('click', () => {
                    window.open(file.download_url, '_blank');
                });
            });
        }
    </script>
</body>
</html>
